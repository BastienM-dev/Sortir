{% extends 'base.html.twig' %}

{% block title %}
    Sorties | {{ parent() }}
{% endblock %}

{% block body %}
    <h4>Filtrer les sorties</h4>

    <form method="get" action="{{ path('sortie_list') }}" class="filter-form form-group">

        <div class="row filters">
            {# Site dropdown #}
            <div></div>
            <div class="col-sm-5 align-items-center">
                <div class="row">
                    <div class="col-auto">
                        <label class="col-form-label" for="site">Campus</label>
                    </div>
                    <div class="col">
                        <select class="form-control-sm-sm w-auto" name="site" id="sortie-site">
                            {% for siteItem in siteList %}
                                <option value="{{ siteItem.id }}"
                                        {% if app.request.query.get('site') and siteItem.id == app.request.query.get('site') %}
                                            selected
                                        {% elseif not app.request.query.get('site') and siteItem.id == site.id %}
                                            selected
                                        {% endif %}>
                                    {{ siteItem.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
           {# Search by sortie name #}
            <div class="row align-items-center">
                <div class="col-auto">
                    <label for="sortie-search" class="col-form-label mb-0">
                        Le nom de la sortie contient
                    </label>
                </div>
                <div class="col">
                    <input class="form-control-sm"
                           type="text"
                           id="sortie-search"
                           name="search"
                           placeholder="Rechercher..."
                           value="{{ app.request.query.get('search') }}">
                </div>
            </div>

            {# Date range #}
           <div class="row align-items-center">
                <div class="col-auto">
                    <label for="date_from" class="col-form-label mb-0">
                        Entre
                    </label>
                </div>

                <div class="col-auto">
                    <input class="form-control-sm"
                           type="date"
                           id="sortie-date_from"
                           name="date_from"
                           value="{{ app.request.query.get('date_from') }}">
                </div>

                <div class="col-auto">
                    <span class="col-form-label">et</span>
                </div>

                <div class="col-auto">
                    <input class="form-control-sm"
                           type="date"
                           id="sortie-date_to"
                           name="date_to"
                           value="{{ app.request.query.get('date_to') }}">
                </div>
            </div>
            </div>

            {# Checkboxes #}
            <div class="col-sm-5">

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="organisateur" value="1"
                           id="organisateur"
                           {% if app.request.query.get('organisateur') %}checked{% endif %}>
                    <label class="form-check-label" for="organisateur">
                        Sorties dont je suis l'organisateur/trice
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="inscrit" value="1"
                           id="inscrit"
                           {% if app.request.query.get('inscrit') %}checked{% endif %}>
                    <label class="form-check-label" for="inscrit">
                        Sorties auxquelles je suis inscrit/e
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="non_inscrit" value="1"
                           id="non_inscrit"
                           {% if app.request.query.get('non_inscrit') %}checked{% endif %}>
                    <label class="form-check-label" for="non_inscrit">
                        Sorties auxquelles je ne suis pas inscrit/e
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="terminees" value="1"
                           id="terminees"
                           {% if app.request.query.get('terminees') %}checked{% endif %}>
                    <label class="form-check-label" for="terminees">
                        Sorties terminées
                    </label>
                </div>

            </div>
            <div class="col-sm-2">
                <button class="btn btn-sortir" type="submit">Rechercher</button>
            </div>
        </div>
    </form>
    <div class="row mb-5">
    </div>

        <div class="row">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
    <table class="table table-striped text-center table-bordered">
        <thead class="thead-dark">
        <tr>
{#            <th>Photo</th>#}
            <th>
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({#}
{#                    'sort': 'nom',#}
{#                    'order': (app.request.query.get('sort') == 'nom' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'#}
{#                })) }}">#}
                    Nom de la sortie
{#                    {% if app.request.query.get('sort') == 'nom' %}#}
{#                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}#}
{#                    {% endif %}#}
                </a>
            </th>
            <th>
                Date de la sortie
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({#}
{#                    'sort': 'dateHeureDebut',#}
{#                    'order': (app.request.query.get('sort') == 'dateHeureDebut' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'#}
{#                })) }}">#}
{#                    Date de la sortie#}
{#                    {% if app.request.query.get('sort') == 'dateHeureDebut' %}#}
{#                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}#}
{#                    {% endif %}#}
{#                </a>#}
            </th>
            <th>
                Clôture
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({#}
{#                    'sort': 'dateLimiteInscription',#}
{#                    'order': (app.request.query.get('sort') == 'dateLimiteInscription' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'#}
{#                })) }}">#}
{#                    Clôture#}
{#                    {% if app.request.query.get('sort') == 'dateLimiteInscription' %}#}
{#                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}#}
{#                    {% endif %}#}
{#                </a>#}
            </th>
            <th>
                Inscrits/Places
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({#}
{#                    'sort': 'nbInscriptionsMax',#}
{#                    'order': (app.request.query.get('sort') == 'nbInscriptionsMax' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'#}
{#                })) }}">#}
{#                    Inscrits/Places#}
{#                    {% if app.request.query.get('sort') == 'nbInscriptionsMax' %}#}
{#                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}#}
{#                    {% endif %}#}
{#                </a>#}
            </th>
            <th>Etat</th>
            <th>Inscrit</th>
            <th>Organisateur</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for sortie in sortieList %}
            <tr>

                {# ✅ Colonne Photo (miniature) #}
{#                <td>#}
{#                    {% if sortie.photoFilename %}#}
{#                        {% set filename = sortie.photoFilename %}#}
{#                        {% set base = filename|split('.')|slice(0, -1)|join('.') %}#}
{#                        {% set thumb = base ~ '.jpg' %}#}

{#                        <img#}
{#                                src="{{ asset('uploads/sorties/thumbs/' ~ thumb) }}"#}
{#                                alt="Miniature sortie"#}
{#                                loading="lazy"#}
{#                                style="width:70px; height:70px; object-fit:cover; border-radius:10px;"#}
{#                                onerror="this.onerror=null;this.src='{{ asset('uploads/sorties/' ~ filename) }}';"#}
{#                        >#}
{#                    {% endif %}#}
{#                </td>#}

                <td class="text-start">{{ sortie.nom }}</td>
                <td>{{ sortie.dateHeureDebut|date('d/m/Y H:i') }}</td>
                <td>{{ sortie.dateLimiteInscription|date('d/m/Y') }}</td>
                <td>{{ sortie.inscriptions|length }}/{{ sortie.nbInscriptionsMax }}</td>
                <td>{{ sortie.etat.libelle }}</td>
                <td>
                    {% if sortie.inscriptions|filter(i => i.participant == app.user)|length > 0 %}
                        X
                    {% endif %}
                </td>
                <td><a href="{{ path('participant_profile', { id: sortie.organisateur.id }) }}">{{ sortie.organisateur.pseudo }}</a></td>
                <td class="text-start">
                    {# Afficher #}
                    <a href="{{ path('sortie_detail', { id: sortie.id }) }}">Afficher</a>

                    {# S'inscrire (si ouverte, pas inscrit, pas organisateur) #}
                    {% if app.user
                        and sortie.etat.libelle == 'Ouverte'
                        and sortie.inscriptions|filter(i => i.participant == app.user)|length == 0
                        and sortie.organisateur != app.user %}
                        <form method="post" action="{{ path('sortie_inscrire', {id: sortie.id}) }}" style="display:inline;">
                            <button type="submit" class="btn btn-link">S'inscrire</button>
                        </form>
                    {% endif %}

                    {# Se désister (si inscrit) #}
                    {% if app.user and sortie.inscriptions|filter(i => i.participant == app.user)|length > 0 %}
                        <form method="post" action="{{ path('sortie_desister', {id: sortie.id}) }}" style="display:inline;">
                            <button type="submit" class="btn btn-link">Se désister</button>
                        </form>
                    {% endif %}

                    {# Modifier (si organisateur et en création) #}
                    {% if app.user and sortie.organisateur == app.user and sortie.etat.libelle == 'En création' %}
                        <a href="{{ path('sortie_edit', {id: sortie.id}) }}">Modifier</a>
                    {% endif %}

                    {# Annuler (si organisateur et ouverte/clôturée) #}
                    {% if app.user
                        and sortie.organisateur == app.user
                        and (sortie.etat.libelle == 'Ouverte' or sortie.etat.libelle == 'Clôturée') %}
                        <a href="{{ path('sortie_annuler', {id: sortie.id}) }}">Annuler</a>
                    {% endif %}

                    {% if app.user and sortie.organisateur == app.user %}
                        <a href="{{ path('sortie_supprimer', {id: sortie.id}) }}">Supprimer</a>
                    {% endif %}
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="9">Aucune sortie disponible</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
            </div>
            </div>

{#    #}{# Affichage de la pagination #}
{#    {% if totalPages > 1 %}#}
{#        <div class="pagination">#}
{#            {% if currentPage > 1 %}#}
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': 1})) }}">« Première</a>#}
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': currentPage - 1})) }}">‹ Précédent</a>#}
{#            {% endif %}#}

{#            {% for page in 1..totalPages %}#}
{#                {% if page == currentPage %}#}
{#                    <strong>{{ page }}</strong>#}
{#                {% else %}#}
{#                    <a href="{{ path('sortie_list', app.request.query.all|merge({'page': page})) }}">{{ page }}</a>#}
{#                {% endif %}#}
{#            {% endfor %}#}

{#            {% if currentPage < totalPages %}#}
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': currentPage + 1})) }}">Suivant ›</a>#}
{#                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': totalPages})) }}">Dernière »</a>#}
{#            {% endif %}#}
{#        </div>#}
{#    {% endif %}#}
    <div class="row mb-3"></div>
    <a href="{{ path('sortie_create') }}" class="btn btn-sortir">Créer un sortie</a>

{% endblock %}