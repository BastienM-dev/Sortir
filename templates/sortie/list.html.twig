{% extends 'base.html.twig' %}

{% block title %}Liste des sorties{% endblock %}

{% block body %}
    <h1>Filtrer les sorties</h1>

    <form method="get" action="{{ path('sortie_list') }}">
        <div>
            <label for="site">Site :</label>
            <select name="site" id="site">
                <option value="">-- Tous les sites --</option>
                {% for site in siteList %}
                    <option value="{{ site.id }}" {% if site.id == app.request.query.get('site') %}selected{% endif %}>
                        {{ site.nom }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="search">Nom contient :</label>
            <input type="text" name="search" id="search" value="{{ app.request.query.get('search') }}">
        </div>

        <div>
            <label for="date_from">Du :</label>
            <input type="date" name="date_from" id="date_from" value="{{ app.request.query.get('date_from') }}">

            <label for="date_to">Au :</label>
            <input type="date" name="date_to" id="date_to" value="{{ app.request.query.get('date_to') }}">
        </div>

        <div>
            <label>
                <input type="checkbox" name="organisateur" value="1" {% if app.request.query.get('organisateur') %}checked{% endif %}>
                Sorties dont je suis l'organisateur/trice
            </label>
        </div>

        <div>
            <label>
                <input type="checkbox" name="inscrit" value="1" {% if app.request.query.get('inscrit') %}checked{% endif %}>
                Sorties auxquelles je suis inscrit/e
            </label>
        </div>

        <div>
            <label>
                <input type="checkbox" name="non_inscrit" value="1" {% if app.request.query.get('non_inscrit') %}checked{% endif %}>
                Sorties auxquelles je ne suis pas inscrit/e
            </label>
        </div>

        <div>
            <label>
                <input type="checkbox" name="terminees" value="1" {% if app.request.query.get('terminees') %}checked{% endif %}>
                Sorties terminées
            </label>
        </div>

        <button type="submit">Rechercher</button>
    </form>

    <h2>Liste des sorties</h2>

    <table border="1">
        <thead>
        <tr>
            <th>Nom</th>
            <th>Date</th>
            <th>Clôture inscription</th>
            <th>Inscrits/Places</th>
            <th>État</th>
            <th>Organisateur</th>
            <th>Inscrit</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for sortie in sortieList %}
            <tr>
                <td>{{ sortie.nom }}</td>
                <td>{{ sortie.dateHeureDebut|date('d/m/Y H:i') }}</td>
                <td>{{ sortie.dateLimiteInscription|date('d/m/Y') }}</td>
                <td>{{ sortie.inscriptions|length }}/{{ sortie.nbInscriptionsMax }}</td>
                <td>{{ sortie.etat.libelle }}</td>
                <td>{{ sortie.organisateur.pseudo }}</td>
                <td>
                    {% if sortie.inscriptions|filter(i => i.participant == app.user)|length > 0 %}
                        ✓
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {# Afficher #}
                    <a href="{{ path('sortie_detail', {id: sortie.id}) }}">Afficher</a>

                    {# S'inscrire (si ouverte, pas inscrit, pas organisateur) #}
                    {% if app.user
                        and sortie.etat.libelle == 'Ouverte'
                        and sortie.inscriptions|filter(i => i.participant == app.user)|length == 0
                        and sortie.organisateur != app.user %}
                        <form method="post" action="{{ path('sortie_inscrire', {id: sortie.id}) }}" style="display:inline;">
                            <button type="submit">S'inscrire</button>
                        </form>
                    {% endif %}

                    {# Se désister (si inscrit) #}
                    {% if app.user and sortie.inscriptions|filter(i => i.participant == app.user)|length > 0 %}
                        <form method="post" action="{{ path('sortie_desister', {id: sortie.id}) }}" style="display:inline;">
                            <button type="submit">Se désister</button>
                        </form>
                    {% endif %}

                    {# Modifier (si organisateur et en création) #}
                    {% if app.user and sortie.organisateur == app.user and sortie.etat.libelle == 'En création' %}
                        <a href="{{ path('sortie_edit', {id: sortie.id}) }}">Modifier</a>
                    {% endif %}

                    {# Annuler (si organisateur et ouverte/clôturée) #}
                    {% if app.user
                        and sortie.organisateur == app.user
                        and (sortie.etat.libelle == 'Ouverte' or sortie.etat.libelle == 'Clôturée') %}
                        <a href="{{ path('sortie_annuler', {id: sortie.id}) }}">Annuler</a>
                    {% endif %}
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="8">Aucune sortie disponible</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}