{% extends 'base.html.twig' %}

{% block title %}
    Sorties | {{ parent() }}
{% endblock %}

{% block body %}

    <form method="get" action="{{ path('sortie_list') }}" class="filter-form">
        <div class="filters">
            {# Site dropdown #}
            <label for="site">Site</label>
            <select name="site" id="sortie-site">
                {% for siteItem in siteList %}
                    <option value="{{ siteItem.id }}"
                            {% if app.request.query.get('site') and siteItem.id == app.request.query.get('site') %}
                                selected
                            {% elseif not app.request.query.get('site') and siteItem.id == site.id %}
                                selected
                            {% endif %}>
                        {{ siteItem.nom }}
                    </option>
                {% endfor %}
            </select>

            {# Search by sortie name #}
            <label for="sortie-search">Le nom de la sortie contient</label>
            <input type="text" id="sortie-search" name="search" placeholder="Rechercher..."
                   value="{{ app.request.query.get('search') }}">

            {# Date range #}
            <label for="date_from">Entre</label>
            <input type="date" id="sortie-date_from" name="date_from" value="{{ app.request.query.get('date_from') }}">
            <span>et</span>
            <input type="date" id="sortie-date_to" name="date_to" value="{{ app.request.query.get('date_to') }}">

            {# Checkboxes #}
            <div class="checkboxes">
                <label>
                    <input type="checkbox" name="organisateur" value="1"
                           {% if app.request.query.get('organisateur') %}checked{% endif %}>
                    Sorties dont je suis l'organisateur/trice
                </label>

                <label>
                    <input type="checkbox" name="inscrit" value="1"
                           {% if app.request.query.get('inscrit') %}checked{% endif %}>
                    Sorties auxquelles je suis inscrit/e
                </label>

                <label>
                    <input type="checkbox" name="non_inscrit" value="1"
                           {% if app.request.query.get('non_inscrit') %}checked{% endif %}>
                    Sorties auxquelles je ne suis pas inscrit/e
                </label>

                <label>
                    <input type="checkbox" name="terminees" value="1"
                           {% if app.request.query.get('terminees') %}checked{% endif %}>
                    Sorties terminées
                </label>
            </div>

            <button type="submit">Rechercher</button>
        </div>
    </form>

    <table class="table">
        <thead>
        <tr>
            <th>Photo</th>
            <th>
                <a href="{{ path('sortie_list', app.request.query.all|merge({
                    'sort': 'nom',
                    'order': (app.request.query.get('sort') == 'nom' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'
                })) }}">
                    Nom de la sortie
                    {% if app.request.query.get('sort') == 'nom' %}
                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}
                    {% endif %}
                </a>
            </th>
            <th>
                <a href="{{ path('sortie_list', app.request.query.all|merge({
                    'sort': 'dateHeureDebut',
                    'order': (app.request.query.get('sort') == 'dateHeureDebut' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'
                })) }}">
                    Date de la sortie
                    {% if app.request.query.get('sort') == 'dateHeureDebut' %}
                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}
                    {% endif %}
                </a>
            </th>
            <th>
                <a href="{{ path('sortie_list', app.request.query.all|merge({
                    'sort': 'dateLimiteInscription',
                    'order': (app.request.query.get('sort') == 'dateLimiteInscription' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'
                })) }}">
                    Clôture
                    {% if app.request.query.get('sort') == 'dateLimiteInscription' %}
                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}
                    {% endif %}
                </a>
            </th>
            <th>
                <a href="{{ path('sortie_list', app.request.query.all|merge({
                    'sort': 'nbInscriptionsMax',
                    'order': (app.request.query.get('sort') == 'nbInscriptionsMax' and app.request.query.get('order') == 'ASC') ? 'DESC' : 'ASC'
                })) }}">
                    Inscrits/Places
                    {% if app.request.query.get('sort') == 'nbInscriptionsMax' %}
                        {{ app.request.query.get('order') == 'ASC' ? '▲' : '▼' }}
                    {% endif %}
                </a>
            </th>
            <th>Etat</th>
            <th>Inscrit</th>
            <th>Organisateur</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for sortie in sortieList %}
            <tr>

                {# ✅ Colonne Photo (miniature) #}
                <td>
                    {% if sortie.photoFilename %}
                        {% set filename = sortie.photoFilename %}
                        {% set base = filename|split('.')|slice(0, -1)|join('.') %}
                        {% set thumb = base ~ '.jpg' %}

                        <img
                                src="{{ asset('uploads/sorties/thumbs/' ~ thumb) }}"
                                alt="Miniature sortie"
                                loading="lazy"
                                style="width:70px; height:70px; object-fit:cover; border-radius:10px;"
                                onerror="this.onerror=null;this.src='{{ asset('uploads/sorties/' ~ filename) }}';"
                        >
                    {% endif %}
                </td>

                <td>{{ sortie.nom }}</td>
                <td>{{ sortie.dateHeureDebut|date('d-m-Y H:i') }}</td>
                <td>{{ sortie.dateLimiteInscription|date('d-m-Y') }}</td>
                <td>{{ sortie.inscriptions|length }}/{{ sortie.nbInscriptionsMax }}</td>
                <td>{{ sortie.etat.libelle }}</td>
                <td>
                    {% if sortie.inscriptions|filter(i => i.participant == app.user)|length > 0 %}
                        X
                    {% endif %}
                </td>
                <td>{{ sortie.organisateur.pseudo }}</td>
                <td>
                    {# Afficher #}
                    <a href="{{ path('sortie_detail', { id: sortie.id }) }}">Afficher</a>

                    {# S'inscrire (si ouverte, pas inscrit, pas organisateur) #}
                    {% if app.user
                        and sortie.etat.libelle == 'Ouverte'
                        and sortie.inscriptions|filter(i => i.participant == app.user)|length == 0
                        and sortie.organisateur != app.user %}
                        <form method="post" action="{{ path('sortie_inscrire', {id: sortie.id}) }}" style="display:inline;">
                            <button type="submit">S'inscrire</button>
                        </form>
                    {% endif %}

                    {# Se désister (si inscrit) #}
                    {% if app.user and sortie.inscriptions|filter(i => i.participant == app.user)|length > 0 %}
                        <form method="post" action="{{ path('sortie_desister', {id: sortie.id}) }}" style="display:inline;">
                            <button type="submit">Se désister</button>
                        </form>
                    {% endif %}

                    {# Modifier (si organisateur et en création) #}
                    {% if app.user and sortie.organisateur == app.user and sortie.etat.libelle == 'En création' %}
                        <a href="{{ path('sortie_edit', {id: sortie.id}) }}">Modifier</a>
                    {% endif %}

                    {# Annuler (si organisateur et ouverte/clôturée) #}
                    {% if app.user
                        and sortie.organisateur == app.user
                        and (sortie.etat.libelle == 'Ouverte' or sortie.etat.libelle == 'Clôturée') %}
                        <a href="{{ path('sortie_annuler', {id: sortie.id}) }}">Annuler</a>
                    {% endif %}
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="9">Aucune sortie disponible</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {# Affichage de la pagination #}
    {% if totalPages > 1 %}
        <div class="pagination">
            {% if currentPage > 1 %}
                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': 1})) }}">« Première</a>
                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': currentPage - 1})) }}">‹ Précédent</a>
            {% endif %}

            {% for page in 1..totalPages %}
                {% if page == currentPage %}
                    <strong>{{ page }}</strong>
                {% else %}
                    <a href="{{ path('sortie_list', app.request.query.all|merge({'page': page})) }}">{{ page }}</a>
                {% endif %}
            {% endfor %}

            {% if currentPage < totalPages %}
                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': currentPage + 1})) }}">Suivant ›</a>
                <a href="{{ path('sortie_list', app.request.query.all|merge({'page': totalPages})) }}">Dernière »</a>
            {% endif %}
        </div>
    {% endif %}

{% endblock %}